<!-- Icon-Challenge Modal -->
<!-- 3×3 Grid mit Count-Challenge -->

<div
  id="icon-challenge-modal"
  class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-gray-950/90 dark:bg-black/95 backdrop-blur-sm animate-in fade-in duration-300"
>
  <div
    class="relative bg-white dark:bg-gray-900 border-2 border-purple-500/30 dark:border-cyan-500/30 w-full max-w-lg rounded-3xl shadow-[0_0_50px_rgba(168,85,247,0.15)] dark:shadow-[0_0_50px_rgba(6,182,212,0.15)] overflow-hidden"
  >
    <!-- ============================================ -->
    <!-- HEADER -->
    <!-- ============================================ -->
    <div
      class="p-6 border-b border-gray-200 dark:border-white/5 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-gray-800/50 dark:to-gray-800/30"
    >
      <h2
        class="text-2xl font-black bg-gradient-to-r from-purple-600 to-pink-600 dark:from-cyan-400 dark:to-blue-400 bg-clip-text text-transparent uppercase tracking-[0.2em] text-center"
      >
        {{ title }}
      </h2>
      <p
        class="text-gray-600 dark:text-gray-400 text-xs text-center mt-2 tracking-widest uppercase"
      >
        {{ description }}
      </p>
    </div>

    <!-- ============================================ -->
    <!-- FRAGE: "Wie viele X siehst du?" -->
    <!-- ============================================ -->
    <div
      class="p-6 bg-gray-50 dark:bg-gray-800/20 border-b border-gray-200 dark:border-white/5"
    >
      <p class="text-center text-gray-700 dark:text-gray-300 text-lg mb-4">
        Wie viele
        <span
          class="inline-flex items-center justify-center w-8 h-8 mx-1 bg-purple-100 dark:bg-cyan-900/30 border border-purple-300 dark:border-cyan-500/30 rounded-lg text-purple-600 dark:text-cyan-400"
        >
          {{ target_svg|safe }}
        </span>
        siehst du?
      </p>

      <div class="flex items-center justify-center gap-2">
        <span
          class="text-sm text-gray-500 dark:text-gray-500 uppercase tracking-wider"
        >
          Ziel:
        </span>
        <span
          class="px-4 py-2 bg-purple-100 dark:bg-cyan-900/30 text-purple-700 dark:text-cyan-400 border border-purple-300 dark:border-cyan-500/30 rounded-full font-bold uppercase tracking-widest"
        >
          {{ target_icon }}
        </span>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 3×3 ICON GRID -->
    <!-- ============================================ -->
    <div class="p-8 bg-white dark:bg-gray-900">
      <div class="grid grid-cols-3 gap-4 max-w-sm mx-auto">
        {% for name, svg in icons %}
        <div
          class="flex items-center justify-center p-4 rounded-xl bg-gray-100 dark:bg-gray-800/30 border border-gray-300 dark:border-white/5 hover:border-purple-400 dark:hover:border-cyan-500/50 hover:bg-purple-50 dark:hover:bg-cyan-500/10 transition-all duration-300"
        >
          <div
            class="w-10 h-10 text-gray-700 dark:text-gray-300 hover:text-purple-600 dark:hover:text-cyan-400 transition-colors"
          >
            {{ svg|safe }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- ============================================ -->
    <!-- COUNT BUTTONS (1-5) -->
    <!-- ============================================ -->
    <div
      class="p-6 border-t border-gray-200 dark:border-white/5 bg-gray-50 dark:bg-gray-800/20"
    >
      <p
        class="text-center text-gray-600 dark:text-gray-400 text-sm uppercase tracking-wider mb-4"
      >
        Deine Antwort:
      </p>

      <div class="flex justify-center gap-3">
        {% for count in "12345" %}
        <button
          hx-post="{% url 'icon_challenge:verify' context_type %}"
          hx-vals='{"count": "{{ count }}"}'
          hx-target="#challenge-result"
          hx-swap="innerHTML"
          hx-disabled-elt="closest div"
          hx-indicator="#loading-spinner"
          class="w-14 h-14 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white font-bold text-xl rounded-xl hover:border-purple-500 dark:hover:border-cyan-500 hover:bg-purple-50 dark:hover:bg-cyan-900/30 hover:text-purple-600 dark:hover:text-cyan-400 hover:scale-110 active:scale-95 transition-all duration-200 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
        >
          {{ count }}
        </button>
        {% endfor %}

        <!-- Loading Spinner (wird während Request gezeigt) -->
        <div id="loading-spinner" class="htmx-indicator mt-4 text-center">
          <svg
            class="animate-spin h-8 w-8 mx-auto text-purple-600 dark:text-cyan-400"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
              fill="none"
            />
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            />
          </svg>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
            Prüfe Antwort...
          </p>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- RESULT CONTAINER (für Success/Error Messages) -->
    <!-- ============================================ -->
    <div
      class="p-6 border-t border-gray-200 dark:border-white/5 bg-white dark:bg-gray-800/20"
    >
      <div
        id="challenge-result"
        class="min-h-[80px] flex items-center justify-center"
      >
        <span
          class="text-gray-400 dark:text-gray-500 uppercase text-xs tracking-[0.4em] animate-pulse"
        >
          System bereit...
        </span>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- CLOSE BUTTON -->
    <!-- ============================================ -->
    <div
      class="p-4 bg-gray-50 dark:bg-gray-800/10 border-t border-gray-200 dark:border-white/5 flex justify-center"
    >
      <button
        onclick="document.getElementById('icon-challenge-modal').remove()"
        class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-xs uppercase tracking-[0.5em] transition-all duration-300 px-6 py-2 hover:bg-gray-200 dark:hover:bg-gray-700/50 rounded-lg"
      >
        /// Abbrechen ///
      </button>
    </div>

    <!-- ============================================ -->
    <!-- DECORATIVE SCAN LINE (Animation) -->
    <!-- ============================================ -->
    <div
      class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-cyan-500 dark:to-blue-500 shadow-[0_0_15px_currentColor] animate-scan opacity-30"
    ></div>
  </div>
</div>
<!-- ============================================ -->
<!-- JAVASCRIPT: Prevent Double-Submit -->
<!-- ============================================ -->
<script>
(function() {
    let isProcessing = false;
    
    // Alle Count-Buttons
    const buttons = document.querySelectorAll('[hx-post*="verify"]');
    
    buttons.forEach(button => {
        button.addEventListener('click', function(e) {
            if (isProcessing) {
                // Lock ist aktiv → verhindere Klick
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            
            // Aktiviere Lock
            isProcessing = true;
            
            // Deaktiviere ALLE Buttons
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
            
            // Nach 3 Sekunden: Reset (falls HTMX hängt)
            setTimeout(() => {
                isProcessing = false;
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            }, 3000);
        });
    });
    
    // HTMX Event Listener: Reset nach Response
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.pathInfo.requestPath.includes('verify')) {
            // Response erhalten → Reset Lock
            isProcessing = false;
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        }
    });
})();
</script>

<!-- ============================================ -->
<!-- ANIMATIONS (CSS) -->
<!-- ============================================ -->
<style>
  /* Shake Animation (bei Fehler) */
  .animate-shake {
    animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
  }

  @keyframes shake {
    10%,
    90% {
      transform: translate3d(-1px, 0, 0);
    }
    20%,
    80% {
      transform: translate3d(2px, 0, 0);
    }
    30%,
    50%,
    70% {
      transform: translate3d(-4px, 0, 0);
    }
    40%,
    60% {
      transform: translate3d(4px, 0, 0);
    }
  }

  /* Scan Line Animation */
  @keyframes scan {
    0% {
      top: 0;
      opacity: 0;
    }
    50% {
      opacity: 0.3;
    }
    100% {
      top: 100%;
      opacity: 0;
    }
  }

  .animate-scan {
    animation: scan 3s linear infinite;
  }

  /* Fade In Animation */
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-in {
    animation: fade-in 0.3s ease-out;
  }
</style>
