{% load static %}
<!DOCTYPE html>
<html lang="de" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Martin Freimuth ‚Äì Portfolio{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: "class" };
    </script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // H√∂re auf das htmx:configRequest Event am document.documentElement (sicherer als body)
        document.documentElement.addEventListener(
          "htmx:configRequest",
          (event) => {
            // Holt den Token direkt aus dem Cookie, falls vorhanden, oder aus dem Template
            const csrfToken =
              document.cookie
                .split("; ")
                .find((row) => row.startsWith("csrftoken="))
                ?.split("=")[1] || "{{ csrf_token }}";

            event.detail.headers["X-CSRFToken"] = csrfToken;
          }
        );
      });
    </script>

    <!-- Favicon -->
    <link rel="icon" href="{% static 'favicon.ico' %}" />

    <!-- Fonts -->
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
    </style>

    <!-- Dark Mode Init (prevents flash) -->
    <script>
      // Direkt beim Laden ausf√ºhren (vor Body!)
      (function () {
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;

        if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add("dark");
        }
      })();
    </script>
  </head>

  <body
    class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300"
  >
   <div class="sticky top-0 z-50">
      <!-- HEADER -->
      <header class="border-b border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-950/80 backdrop-blur-xl transition-colors duration-300">
        <nav class="max-w-7xl mx-auto px-6 py-5">
          
          <!-- ========== DESKTOP NAV ========== -->
          <div class="hidden lg:flex items-center justify-center flex-1 gap-8 text-lg">
            <a href="{% url 'core:home' %}" class="text-gray-700 dark:text-gray-300 hover:text-purple-600 dark:hover:text-purple-400 transition">
              Home
            </a>
            <a href="{% url 'core:skills' %}" class="text-gray-700 dark:text-gray-300 hover:text-purple-600 dark:hover:text-purple-400 transition">
              Skills
            </a>
            <a href="{% url 'projects:public_list' %}" class="text-gray-900 dark:text-white font-bold hover:text-purple-600 dark:hover:text-purple-400 transition">
              Projekte
            </a>
            <a href="{% url 'core:about' %}" class="text-gray-700 dark:text-gray-300 hover:text-purple-600 dark:hover:text-purple-400 transition">
              √úber mich
            </a>
            <a href="{% url 'core:contact' %}" class="text-gray-700 dark:text-gray-300 hover:text-purple-600 dark:hover:text-purple-400 transition">
              Kontakt
            </a>

            <!-- Theme Toggle (Desktop) -->
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition" title="Dark/Light Mode">
              <svg id="sun" class="w-6 h-6 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
              </svg>
              <svg id="moon" class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
              </svg>
            </button>

            {% if user.is_authenticated %}
            <span class="text-green-600 dark:text-green-400 font-bold">Hi {{ user.email }}!</span>
            <a href="{% url 'account_logout' %}" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-lg transition">Logout</a>
            {% else %}
            <a href="#" hx-get="{% url 'icon_challenge:start' 'guest' %}" hx-target="#modal-container" hx-swap="innerHTML"
               class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white px-8 py-3 rounded-full font-bold shadow-lg transition">
              üîê Gast-Zugang
            </a>
            <a href="{% url 'account_login' %}" class="text-gray-700 dark:text-gray-300 hover:text-purple-600 dark:hover:text-purple-400 text-sm font-medium transition">
              Registriert? Login
            </a>
            {% endif %}

            <!-- Guest Timer (Desktop) -->
            {% if guest_remaining %}
            <div class="flex items-center space-x-3 bg-slate-200/50 dark:bg-cyan-950/40 border border-slate-300 dark:border-cyan-500/30 px-4 py-1.5 rounded-full shadow-sm">
              <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-500 dark:bg-cyan-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-600 dark:bg-cyan-500"></span>
              </span>
              <div class="flex flex-col leading-none">
                <span class="text-[9px] text-slate-500 dark:text-cyan-500/70 uppercase tracking-[0.2em] mb-1">Gast-Sitzung</span>
                <span class="text-slate-900 dark:text-cyan-400 font-mono text-xs font-bold uppercase">
                  Auto-Purge: <span id="nav-timer">{{ guest_remaining }}</span> sec
                </span>
              </div>
            </div>
            <script>
              (function () {
                let timeLeft = parseInt("{{ guest_remaining|default:0 }}");
                const display = document.getElementById("nav-timer");
                if (isNaN(timeLeft) || timeLeft <= 0) return;
                const interval = setInterval(() => {
                  timeLeft--;
                  if (display) {
                    display.innerText = timeLeft;
                    if (timeLeft < 30) {
                      const parent = display.parentElement;
                      parent.classList.remove("text-cyan-400");
                      parent.classList.add("text-red-500", "animate-pulse");
                    }
                  }
                  if (timeLeft <= 0) {
                    clearInterval(interval);
                    window.location.href = "{% url 'account_logout' %}?timeout=1";
                  }
                }, 1000);
              })();
            </script>
            {% endif %}
          </div>

          <!-- ========== MOBILE HEADER ========== -->
          <div class="flex items-center justify-between lg:hidden">
            
            <!-- Hamburger (Links) -->
            <button id="mobile-menu-btn" class="p-2 text-gray-700 dark:text-gray-300 hover:text-purple-600 transition">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
            
            <!-- Guest Timer (Mitte-Rechts) -->
            {% if guest_remaining %}
            <div class="flex items-center gap-2 px-3 py-1.5 bg-red-100 dark:bg-red-900/30 border border-red-500 rounded-full">
              <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-red-600"></span>
              </span>
              <span class="text-red-700 dark:text-red-400 font-mono text-xs font-bold">
                <span id="mobile-header-timer">{{ guest_remaining }}</span>s
              </span>
            </div>
            <script>
              (function () {
                let timeLeft = parseInt("{{ guest_remaining|default:0 }}");
                const display = document.getElementById("mobile-header-timer");
                if (isNaN(timeLeft) || timeLeft <= 0 || !display) return;
                const interval = setInterval(() => {
                  timeLeft--;
                  display.innerText = timeLeft;
                  if (timeLeft <= 0) {
                    clearInterval(interval);
                    window.location.href = "{% url 'account_logout' %}?timeout=1";
                  }
                }, 1000);
              })();
            </script>
            {% endif %}
            
            <!-- Theme Toggle (Rechts) -->
            <button id="mobile-theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition">
              <svg id="mobile-sun" class="w-6 h-6 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
              </svg>
              <svg id="mobile-moon" class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
              </svg>
            </button>
            
          </div>
          
        </nav>
      </header>

  
    
  </nav>
</header>

<!-- User Subnav (Desktop only) -->
{% include 'partials/user_subnav.html' %}

</div>
<!-- ========== ENDE STICKY WRAPPER ========== -->

<!-- ========== MOBILE MENU (FULLSCREEN) ========== -->
<div id="mobile-menu" class="hidden lg:hidden fixed inset-0 z-40 bg-white dark:bg-gray-950">
  <div class="flex flex-col h-full">
    
    <!-- Header -->
    <div class="flex justify-between items-center px-6 py-5 border-b border-gray-200 dark:border-gray-800">
      <span class="text-2xl font-black text-gray-900 dark:text-white">Menu</span>
    </div>

    <!-- Content (scrollable) -->
    <div class="flex-1 overflow-y-auto px-6 py-8">
      
      <!-- ========== 2-SPALTEN GRID ========== -->
      <div class="grid grid-cols-2 gap-6 mb-8">
        
        <!-- LINKE SPALTE: Main Navigation -->
        <div class="space-y-4">
          <h3 class="text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400 font-bold mb-4">Navigation</h3>
          
          <a href="{% url 'core:home' %}" 
             class="block text-xl font-bold text-gray-900 dark:text-white hover:text-purple-600 dark:hover:text-purple-400 transition">
            Home
          </a>
          <a href="{% url 'core:skills' %}" 
             class="block text-xl font-bold text-gray-900 dark:text-white hover:text-purple-600 dark:hover:text-purple-400 transition">
            Skills
          </a>
          <a href="{% url 'projects:public_list' %}" 
             class="block text-xl font-bold text-gray-900 dark:text-white hover:text-purple-600 dark:hover:text-purple-400 transition">
            Projekte
          </a>
          <a href="{% url 'core:about' %}" 
             class="block text-xl font-bold text-gray-900 dark:text-white hover:text-purple-600 dark:hover:text-purple-400 transition">
            √úber mich
          </a>
          <a href="{% url 'core:contact' %}" 
             class="block text-xl font-bold text-gray-900 dark:text-white hover:text-purple-600 dark:hover:text-purple-400 transition">
            Kontakt
          </a>
        </div>
        
        <!-- RECHTE SPALTE: User Subnav (nur f√ºr eingeloggte) -->
        {% if user.is_authenticated %}
        <div class="space-y-2">
          <h3 class="text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400 font-bold mb-4">Dein Bereich</h3>
          
          <!-- Secret Lab -->
          <a href="{% url 'projects:secret_lab' %}" 
             class="flex items-center gap-2 px-3 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 
                    border border-purple-300 dark:border-purple-700 rounded-full font-semibold 
                    hover:bg-purple-200 dark:hover:bg-purple-900/50 transition">
            <span class="text-base">üî¨</span>
            <span>Secret Lab</span>
          </a>
          
          <!-- About Portfolio -->
          <a href="{% url 'core:about_portfolio' %}" 
             class="flex items-center gap-2 px-3 py-2 bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-400 
                    border border-cyan-300 dark:border-cyan-700 rounded-full text-sm font-semibold 
                    hover:bg-cyan-200 dark:hover:bg-cyan-900/50 transition">
            <span class="text-base">üìä</span>
            <span>About Portfolio</span>
          </a>
          
          <!-- Current Project -->
          <a href="{% url 'core:in_progress' %}" 
             class="flex items-center gap-2 px-3 py-2 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 
                    border border-orange-300 dark:border-orange-700 rounded-full text-sm font-semibold 
                    hover:bg-orange-200 dark:hover:bg-orange-900/50 transition">
            <span class="text-base">üöÄ</span>
            <span>Current Projekte</span>
          </a>
          
          <!-- Next Ideas -->
          <a href="{% url 'core:in_progress' %}" 
             class="flex items-center gap-2 px-3 py-2 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 
                    border border-yellow-300 dark:border-yellow-700 rounded-full text-sm font-semibold 
                    hover:bg-yellow-200 dark:hover:bg-yellow-900/50 transition">
            <span class="text-base">üí°</span>
            <span>Next Ideas</span>
          </a>
          
          <!-- CV -->
          <a href="{% url 'core:in_progress' %}" 
             class="flex items-center gap-2 px-3 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 
                    border border-green-300 dark:border-green-700 rounded-full text-sm font-semibold 
                    hover:bg-green-200 dark:hover:bg-green-900/50 transition">
            <span class="text-base">üìÑ</span>
            <span>CV</span>
          </a>
          
          <!-- IT Blog -->
          <a href="{% url 'core:in_progress' %}" 
             class="flex items-center gap-2 px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 
                    border border-blue-300 dark:border-blue-700 rounded-full text-sm font-semibold 
                    hover:bg-blue-200 dark:hover:bg-blue-900/50 transition">
            <span class="text-base">üìù</span>
            <span>IT Blog</span>
          </a>
          
          <!-- Training -->
          <a href="{% url 'core:in_progress' %}" 
             class="flex items-center gap-2 px-3 py-2 bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-400 
                    border border-pink-300 dark:border-pink-700 rounded-full text-sm font-semibold 
                    hover:bg-pink-200 dark:hover:bg-pink-900/50 transition">
            <span class="text-base">üéì</span>
            <span>Training</span>
          </a>
        </div>
        {% endif %}
        
      </div>
      <!-- ========== ENDE 2-SPALTEN GRID ========== -->

      <hr class="border-gray-300 dark:border-gray-700 my-6" />

      <!-- ========== AUTH SECTION (Full Width) ========== -->
      {% if user.is_authenticated %}
      <div class="space-y-4">
        <div class="text-green-600 dark:text-green-400 font-bold text-lg text-center">
          Hi {{ user.email }}!
        </div>
        <a href="{% url 'account_logout' %}" 
           class="block px-6 py-4 bg-red-600 hover:bg-red-700 text-white font-bold text-xl text-center rounded-full transition">
          Logout
        </a>
      </div>
      {% else %}
      <div class="space-y-4">
        <!-- Gast-Zugang -->
        <a href="#" 
           hx-get="{% url 'icon_challenge:start' 'guest' %}"
           hx-target="#modal-container"
           hx-swap="innerHTML"
           class="block px-6 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-xl text-center rounded-2xl shadow-lg">
          üîê Gast-Zugang
        </a>

        <!-- Registrierter Login -->
        <a href="{% url 'account_login' %}" 
           class="block px-6 py-4 border-2 border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white font-bold text-lg text-center rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-800 transition">
          Registriert? Login
        </a>
      </div>
      {% endif %}
      
    </div>
  </div>
</div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <!-- MAIN CONTENT -->
    <main
      class="flex-1 min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-black transition-colors duration-300"
    >
      <div class="max-w-7xl mx-auto px-6 py-12">
        {% block content %}{% endblock %}
      </div>
    </main>

    <!-- FOOTER -->
    <footer
      class="py-10 text-center text-gray-600 dark:text-gray-400 text-sm border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950 transition-colors duration-300"
    >
      ¬© 2025 Martin Freimuth ‚Äì Built with Django, blood & caffeine ‚Ä¢
      <a
        href="{% url 'legal:impressum' %}"
        class="hover:text-purple-600 dark:hover:text-purple-400 transition"
        >Impressum</a
      >
      ‚Ä¢
      <a
        href="{% url 'legal:datenschutz' %}"
        class="hover:text-purple-600 dark:hover:text-purple-400 transition"
        >Datenschutz</a
      >
    </footer>

    <!-- ========================================= -->
<!-- MOBILE MENU SCRIPT -->
<!-- ========================================= -->
<script>
  const mobileMenuBtn = document.getElementById("mobile-menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");

  if (mobileMenuBtn && mobileMenu) {
    mobileMenuBtn.addEventListener("click", function () {
      // Toggle (√∂ffnen/schlie√üen)
      if (mobileMenu.classList.contains("hidden")) {
        // √ñffnen
        mobileMenu.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      } else {
        // Schlie√üen
        mobileMenu.classList.add("hidden");
        document.body.style.overflow = "";
      }
    });
  }

  // Links schlie√üen Menu auch
  if (mobileMenu) {
    const mobileMenuLinks = mobileMenu.querySelectorAll("a");
    mobileMenuLinks.forEach(function (link) {
      link.addEventListener("click", function () {
        mobileMenu.classList.add("hidden");
        document.body.style.overflow = "";
      });
    });
  }
</script>

    <!-- ========================================= -->
    <!-- MOBILE THEME TOGGLE SCRIPT -->
    <!-- ========================================= -->
    <script>
      const mobileToggle = document.getElementById("mobile-theme-toggle");
      const mobileSun = document.getElementById("mobile-sun");
      const mobileMoon = document.getElementById("mobile-moon");

      function updateMobileIcons() {
        const isDark = document.documentElement.classList.contains("dark");
        if (isDark) {
          mobileSun.classList.remove("hidden");
          mobileMoon.classList.add("hidden");
        } else {
          mobileSun.classList.add("hidden");
          mobileMoon.classList.remove("hidden");
        }
      }

      updateMobileIcons();

      mobileToggle.addEventListener("click", function () {
        document.documentElement.classList.toggle("dark");
        const isDark = document.documentElement.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        updateMobileIcons();
        
        // Sync mit Desktop Toggle
        const desktopSun = document.getElementById("sun");
        const desktopMoon = document.getElementById("moon");
        if (isDark) {
          desktopSun.classList.remove("hidden");
          desktopMoon.classList.add("hidden");
        } else {
          desktopSun.classList.add("hidden");
          desktopMoon.classList.remove("hidden");
        }
      });
    </script>

    <!-- ========================================= -->
    <!-- DESKTOP THEME TOGGLE SCRIPT -->
    <!-- ========================================= -->
    <script>
      const toggle = document.getElementById("theme-toggle");
      const sun = document.getElementById("sun");
      const moon = document.getElementById("moon");

      function updateIcons() {
        const isDark = document.documentElement.classList.contains("dark");
        if (isDark) {
          sun.classList.remove("hidden");
          moon.classList.add("hidden");
        } else {
          sun.classList.add("hidden");
          moon.classList.remove("hidden");
        }
      }

      updateIcons();

      toggle.addEventListener("click", function () {
        document.documentElement.classList.toggle("dark");
        const isDark = document.documentElement.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        updateIcons();
        
        // Sync mit Mobile Toggle
        if (mobileSun && mobileMoon) {
          if (isDark) {
            mobileSun.classList.remove("hidden");
            mobileMoon.classList.add("hidden");
          } else {
            mobileSun.classList.add("hidden");
            mobileMoon.classList.remove("hidden");
          }
        }
      });
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>